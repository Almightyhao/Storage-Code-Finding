<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>藥品儲位快速查找（GitHub 最新＋進階設定）</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
    <header class="space-y-1">
      <h1 class="text-2xl font-bold">藥品儲位快速查找</h1>
      <p class="text-sm text-gray-600">資料來源固定為 GitHub <a href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx" target="_blank" class="underline">Raw</a>（每次開啟自動抓最新）。支援：選工作表、選表頭列、欄位映射、忽略符號空白、多關鍵字搜尋。</p>
    </header>

    <section class="bg-white rounded-2xl shadow p-4 space-y-4">
      <div class="grid gap-2 sm:grid-cols-[1fr_auto_auto_auto]">
        <div class="flex items-center border rounded-xl bg-white px-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
          </svg>
          <input id="txtQuery" class="w-full outline-none py-2" placeholder="例：BD 31G 8MM 或 阿莫" />
          <button id="btnClear" class="text-gray-500 hover:text-gray-700" title="清除">✕</button>
        </div>
        <select id="selScope" class="border rounded-lg px-3 py-2">
          <option value="all">搜尋全部欄位</option>
          <option value="藥品名稱">只搜：藥品名稱</option>
          <option value="儲位區">只搜：儲位區</option>
          <option value="庫存區">只搜：庫存區</option>
        </select>
        <input id="numShow" type="number" min="1" value="100" class="border rounded-lg px-3 py-2" title="顯示筆數" />
        <button id="btnReload" class="border rounded-lg px-3 py-2 bg-white hover:bg-gray-50">重新抓取GitHub</button>
      </div>

      <div class="grid gap-3 sm:grid-cols-4">
        <div class="flex flex-col gap-1">
          <span class="text-xs text-gray-500">工作表</span>
          <select id="selSheet" class="border rounded-lg px-3 py-2"></select>
        </div>
        <div class="flex flex-col gap-1">
          <span class="text-xs text-gray-500">表頭列（第幾列當欄名）</span>
          <input id="headerRow" type="number" min="1" value="1" class="border rounded-lg px-3 py-2" />
        </div>
        <div class="flex flex-col gap-1">
          <span class="text-xs text-gray-500">藥名欄對應</span>
          <select id="mapName" class="border rounded-lg px-3 py-2"></select>
        </div>
        <div class="flex flex-col gap-1">
          <span class="text-xs text-gray-500">儲位欄對應</span>
          <select id="mapLoc" class="border rounded-lg px-3 py-2"></select>
        </div>
      </div>
      <div class="grid gap-3 sm:grid-cols-4">
        <div class="flex flex-col gap-1">
          <span class="text-xs text-gray-500">庫存欄對應</span>
          <select id="mapStock" class="border rounded-lg px-3 py-2"></select>
        </div>
        <label class="flex items-center gap-2 text-sm text-gray-700">
          <input id="chkIgnorePunc" type="checkbox" checked />
          忽略空白與符號（例：31G/8MM == 31G 8MM）
        </label>
        <label class="flex items-center gap-2 text-sm text-gray-700">
          <input id="chkAllTokens" type="checkbox" checked />
          多關鍵字需全部命中（空白分詞）
        </label>
      </div>

      <div class="text-sm text-gray-600 flex flex-wrap gap-4">
        <div>符合 <b id="matchCount">0</b> 筆；顯示前 <span id="lblShow">100</span> 筆</div>
        <div>已載入列數：<b id="loadedRows">0</b></div>
        <div>偵測到欄位：<span id="detectedCols" class="font-mono"></span></div>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow overflow-hidden">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-3 py-2 text-left whitespace-nowrap border-b">藥品名稱</th>
              <th class="px-3 py-2 text-left whitespace-nowrap border-b">儲位區</th>
              <th class="px-3 py-2 text-left whitespace-nowrap border-b">庫存區</th>
              <th class="px-3 py-2 text-left whitespace-nowrap border-b">快捷</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
const RAW_URL = "https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";
const $ = (id) => document.getElementById(id);

let wb = null;            // SheetJS workbook
let currentSheet = "";    // sheet name
let tableRows = [];       // array of objects built using selected header row
let headers = [];         // headers detected for current sheet

// ---------- Normalizers ----------
function stripPuncSpaces(s) {
  const t = (s ?? "").toString();
  // keep letters, numbers, CJK; remove others
  return t.replace(/[^0-9A-Za-z\u4e00-\u9fa5]+/g, "").toLowerCase();
}
function contains(hay, needle, ignorePunc) {
  const H = ignorePunc ? stripPuncSpaces(hay) : (hay ?? "").toString().toLowerCase();
  const N = ignorePunc ? stripPuncSpaces(needle) : (needle ?? "").toString().toLowerCase();
  return H.includes(N);
}

// ---------- Build tableRows from a sheet with chosen header row ----------
function buildFromSheet(sheetName, headerRowIdx /*1-based*/) {
  const ws = wb.Sheets[sheetName];
  if (!ws) return;
  const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
  const idx = Math.max(1, headerRowIdx) - 1;
  const head = (arr[idx] || []).map(x => (x ?? "").toString().trim());
  headers = head;
  const out = [];
  for (let r = idx + 1; r < arr.length; r++) {
    const row = arr[r] || [];
    const obj = {};
    head.forEach((h, i) => { if (h) obj[h] = row[i] ?? ""; });
    if (Object.keys(obj).length) out.push(obj);
  }
  tableRows = out;
  $("loadedRows").textContent = tableRows.length;
  $("detectedCols").textContent = head.join(" | ");
  // fill mapping dropdowns
  [ "mapName", "mapLoc", "mapStock" ].forEach(id => {
    const sel = $(id); sel.innerHTML = "";
    head.forEach(h => { const o = document.createElement("option"); o.value = h; o.textContent = h; sel.appendChild(o); });
  });
  // try to auto-select
  autoMap();
  render();
}

function autoMap() {
  function pick(keys, kws) {
    const lower = keys.map(k => k.toLowerCase());
    for (const kw of kws) { const i = lower.indexOf(kw.toLowerCase()); if (i !== -1) return keys[i]; }
    for (const kw of kws) { const i = lower.findIndex(k => k.includes(kw.toLowerCase())); if (i !== -1) return keys[i]; }
    return keys[0] || "";
  }
  const keyName = pick(headers, ["藥品名稱","品名","藥名","name"]);
  const keyLoc  = pick(headers, ["儲位區","庫位","儲位","location","bin","slot"]);
  const keyStock= pick(headers, ["庫存區","庫存","stock","存量"]);
  $("mapName").value = keyName;
  $("mapLoc").value = keyLoc;
  $("mapStock").value = keyStock;
}

// ---------- Rendering ----------
function highlight(text, q, ignorePunc) {
  const t = (text ?? "").toString();
  if (!q) return t;
  if (ignorePunc) {
    // cannot reliably position; just return text (still filter works)
    return t;
  }
  const needle = q.toLowerCase();
  const idx = t.toLowerCase().indexOf(needle);
  if (idx === -1) return t;
  return t.slice(0, idx) + '<mark class="bg-yellow-200 px-0.5 rounded">' + t.slice(idx, idx + q.length) + "</mark>" + t.slice(idx + q.length);
}

function render() {
  const tbody = $("tbody");
  const q = $("txtQuery").value.trim();
  const scope = $("selScope").value;
  const n = Math.max(1, parseInt($("numShow").value || "100", 10));
  const ignorePunc = $("chkIgnorePunc").checked;
  const allTokens = $("chkAllTokens").checked;
  $("lblShow").textContent = n;

  const nameKey = $("mapName").value;
  const locKey  = $("mapLoc").value;
  const stockKey= $("mapStock").value;

  // tokenize by spaces
  const tokens = q ? q.split(/\s+/).filter(Boolean) : [];
  function matchesRow(r) {
    if (tokens.length === 0) return true;
    const fields = [
      r[nameKey] ?? "",
      r[locKey] ?? "",
      r[stockKey] ?? ""
    ];
    function hasToken(tok) {
      if (scope === "藥品名稱") return contains(r[nameKey], tok, ignorePunc);
      if (scope === "儲位區") return contains(r[locKey], tok, ignorePunc);
      if (scope === "庫存區") return contains(r[stockKey], tok, ignorePunc);
      // all
      return fields.some(f => contains(f, tok, ignorePunc));
    }
    if (allTokens) return tokens.every(t => hasToken(t));
    return tokens.some(t => hasToken(t));
  }

  const filtered = tableRows.filter(matchesRow);
  $("matchCount").textContent = filtered.length;
  const data = filtered.slice(0, n);

  tbody.innerHTML = "";
  if (tableRows.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4; td.className = "text-center text-gray-500 py-10";
    td.textContent = "尚未載入資料或欄位對應未設定。";
    tr.appendChild(td); tbody.appendChild(tr); return;
  }
  if (data.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4; td.className = "text-center text-gray-500 py-10";
    td.textContent = q ? `找不到符合「${q}」的資料` : "沒有資料可顯示";
    tr.appendChild(td); tbody.appendChild(tr); return;
  }

  for (const r of data) {
    const tr = document.createElement("tr"); tr.className = "odd:bg-white even:bg-gray-50 hover:bg-blue-50";
    const cells = [ r[nameKey], r[locKey], r[stockKey] ];
    [0,1,2].forEach(i => {
      const td = document.createElement("td"); td.className = "px-3 py-2 border-b align-top";
      td.innerHTML = highlight(cells[i], q, ignorePunc);
      tr.appendChild(td);
    });
    const tdQ = document.createElement("td"); tdQ.className = "px-3 py-2 border-b align-top";
    const btn = document.createElement("button"); btn.className = "px-2 py-1 rounded border text-xs hover:bg-gray-50"; btn.textContent = "複製儲位";
    btn.onclick = async () => { try { await navigator.clipboard.writeText((r[locKey] ?? "").toString()); alert("已複製儲位區： " + (r[locKey] ?? "")); } catch(e){} };
    tdQ.appendChild(btn); tr.appendChild(tdQ);
    tbody.appendChild(tr);
  }
}

// ---------- Loading from GitHub ----------
async function fetchWorkbook() {
  const resp = await fetch(RAW_URL + "?_ts=" + Date.now());
  if (!resp.ok) throw new Error("HTTP " + resp.status);
  const buf = await resp.arrayBuffer();
  return XLSX.read(buf, { type: "array" });
}

async function loadFromGitHub() {
  try {
    wb = await fetchWorkbook();
    // fill sheet names
    const sel = $("selSheet"); sel.innerHTML = "";
    wb.SheetNames.forEach(n => { const o = document.createElement("option"); o.value = o.textContent = n; sel.appendChild(o); });
    currentSheet = wb.SheetNames[0];
    $("selSheet").value = currentSheet;
    // default header row 1
    buildFromSheet(currentSheet, parseInt($("headerRow").value || "1", 10));
  } catch (e) {
    console.error(e);
    const tbody = $("tbody"); tbody.innerHTML = "";
    const tr = document.createElement("tr"); const td = document.createElement("td");
    td.colSpan = 4; td.className = "text-center text-red-600 py-10";
    td.textContent = "載入失敗：" + e.message; tr.appendChild(td); tbody.appendChild(tr);
  }
}

// ---------- Events ----------
$("btnReload").addEventListener("click", loadFromGitHub);
$("selSheet").addEventListener("change", (e) => { currentSheet = e.target.value; buildFromSheet(currentSheet, parseInt($("headerRow").value || "1", 10)); });
$("headerRow").addEventListener("input", () => { buildFromSheet(currentSheet, parseInt($("headerRow").value || "1", 10)); });
["mapName","mapLoc","mapStock"].forEach(id => $(id).addEventListener("change", render));
$("txtQuery").addEventListener("input", render);
$("btnClear").addEventListener("click", () => { $("txtQuery").value = ""; render(); });
$("selScope").addEventListener("change", render);
$("numShow").addEventListener("input", render);
$("chkIgnorePunc").addEventListener("change", render);
$("chkAllTokens").addEventListener("change", render);

// Init
loadFromGitHub();
</script>
</body>
</html>
