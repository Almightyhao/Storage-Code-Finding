<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- 
  [Gemini] ä¿®æ”¹æ¨™é¡Œä»¥åæ˜ ä½é™¢è—¥å±€ç‰ˆæœ¬ 
-->
<title>ä½é™¢è—¥å±€å„²ä½æŸ¥è©¢ | Inpatient Pharmacy Finder</title>

<!-- 
  [Gemini] æ–°å¢ï¼šç¶²é  App åœ–ç¤º (Web App Icons)
  
  **é‡è¦å‰æ**ï¼š
  æ‚¨å¿…é ˆå°‡ 'IPD.jpg' æª”æ¡ˆä¸Šå‚³åˆ° GitHub å„²å­˜åº«çš„æ ¹ç›®éŒ„ (main åˆ†æ”¯)ã€‚
  ç¨‹å¼æœƒå¾ä»¥ä¸‹ URL è®€å–åœ–ç¤º:
  https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg
-->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">

<!-- é©ç”¨æ–¼ Apple è£ç½® (iOS) -->
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">

<!-- é©ç”¨æ–¼ Android / ç€è¦½å™¨åˆ†é åœ–ç¤º (Favicon) -->
<link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">
<link rel="shortcut icon" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">
<!-- [Gemini] åœ–ç¤ºæ–°å¢å®Œç•¢ -->


<style>
:root {--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial;}
.wrap{max-width:960px;margin:40px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
h1{margin:0 0 8px;font-size:22px}
.sub{color:var(--muted);margin-bottom:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input[type=text]{flex:1;min-width:220px;border:1px solid #1f2937;background:#0b1220;color:var(--text);
  border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
input::placeholder{color:#64748b}
button{background:var(--accent);border:0;color:#0b1220;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
button:disabled{opacity:.6;cursor:not-allowed}
.meta{font-size:12px;color:var(--muted);margin-top:10px}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px;word-break:break-all}
th,td{padding:12px 8px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:middle}
th{font-weight:700;color:#cbd5e1}
tr:hover{background:#0b1220}
.badge{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
.empty{color:var(--muted);padding:24px 8px;text-align:center}
.err{color:#fecaca}
.chk-cell{width:40px;text-align:center}
.chk{width:18px;height:18px;cursor:pointer}
.selected-header{display:flex;align:items-center;justify-content:space-between;margin-top:24px}
.selected-count{font-size:14px;color:#cbd5e1}
.pill{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
.selected-actions{display:flex;gap:8px}
.ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
.mini{padding:8px 10px;font-size:14px}
.selected-table td,.selected-table th{border-bottom:1px solid #1f2937}

.qty-input{
  width:60px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e5e7eb;
  border-radius:8px;
  padding:6px;
  font-size:15px;
  font-weight:600;
  text-align:center;
  outline:none;
}
.qty-input::-webkit-inner-spin-button,
.qty-input::-webkit-outer-spin-button{
  -webkit-appearance:none;margin:0;
}

.remove-btn{
  background:transparent;
  border:1px solid #334155;
  color:#cbd5e1;
  padding:4px 8px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  line-height:1;
}
.remove-btn:hover{background:#1f2937;border-color:#475569;color:#fca5a5}

/* [Gemini] æ–°å¢å–®ä½é¸å–®çš„æ¨£å¼ 
*/
.unit-selector {
  margin-bottom: 16px;
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  border-bottom: 1px solid #1f2937;
  padding-bottom: 16px;
}
.unit-selector label {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text);
  cursor: pointer;
  font-size: 15px;
}
.unit-selector input {
  width: 16px;
  height: 16px;
  accent-color: var(--accent);
}

@media (max-width:600px){
  th,td{font-size:14px;padding:10px 6px;}
  .qty-input{width:55px;font-size:15px;}
  .remove-btn{padding:4px 6px;font-size:15px;}
}
</style>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
<div class="wrap"><div class="card">
<h1>ä½é™¢è—¥å±€å„²ä½æŸ¥è©¢</h1>
<div class="sub">è³‡æ–™ä¾†æºæœƒè‡ªå‹•æŠ“å– GitHub ä¸Š <span class="badge">main</span> åˆ†æ”¯çš„æœ€æ–°ä½é™¢è—¥å±€ Excelã€‚</div>

<!-- 
  [Gemini] æ–°å¢å–®ä½é¸å–® 
-->
<div class="unit-selector">
  <label><input type="radio" name="unit" value="general" checked> ä¸€èˆ¬èª¿åŠ‘</label>
  <label><input type="radio" name="unit" value="ud"> UDèª¿åŠ‘</label>
  <label><input type="radio" name="unit" value="firstdose"> é¦–æ—¥èª¿åŠ‘</label>
</div>

<div class="row">
  <input id="q" type="text" placeholder="è¼¸å…¥è—¥åï¼ˆæ”¯æ´æ¨¡ç³Šæœå°‹èˆ‡éƒ¨åˆ†é—œéµå­—ï¼‰">
  <button id="reloadBtn">é‡æ–°æ•´ç†</button>
</div>
<div id="meta" class="meta"></div><div id="error" class="meta err"></div>

<table id="tbl">
<thead><tr>
  <th class="chk-cell"><input id="toggleAll" class="chk" type="checkbox"></th>
  <th>è—¥å“åç¨±</th>
  <!-- [Gemini] ä¿®æ”¹æ¬„ä½åç¨± -->
  <th>å„²ä½å€</th>
  <th>å„²ä½ä»£ç¢¼</th>
</tr></thead>
<tbody id="tbody"><tr><td colspan="4" class="empty">å°šæœªè¼‰å…¥è³‡æ–™â€¦</td></tr></tbody>
</table>

<div class="selected-header">
  <div class="selected-count">å·²é¸æ¸…å–® <span id="selCount" class="pill">0</span></div>
  <div class="selected-actions">
    <button id="exportBtn" class="ghost mini">åŒ¯å‡º CSV</button>
    <button id="clearBtn" class="ghost mini">å…¨éƒ¨æ¸…ç©º</button>
  </div>
</div>

<table class="selected-table">
<thead><tr>
  <th>è—¥å“åç§°</th>
  <!-- [Gemini] æ–°å¢ã€Œå–®ä½ã€æ¬„ï¼Œä¸¦ä¿®æ”¹æ¬„ä½åç¨± -->
  <th>å–®ä½</th>
  <th>å„²ä½å€</th>
  <th>å„²ä½ä»£ç¢¼</th>
  <th>è£œå……æ•¸é‡</th>
  <th>æ“ä½œ</th>
</tr></thead>
<tbody id="selBody"><tr><td colspan="6" class="empty">å°šç„¡å‹¾é¸é …ç›®</td></tr></tbody>
</table>
</div></div>

<script>
(()=> {
// [Gemini] æ›´æ–° RAW_URL ä»¥æŒ‡å‘æ–°çš„ Excel æª”æ¡ˆ 'Storage Code.xlsx'
const RAW_URL="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";

// [Gemini] æ›´æ–°æ¬„ä½é—œéµå­—
const NAME_KEYS=["è—¥å","å“å","Drug","Name","åç¨±"];
const G_AREA_KEYS = ["ä¸€èˆ¬å„²ä½å€"];
const G_CODE_KEYS = ["ä¸€èˆ¬å„²ä½å€ä»£ç¢¼"];
const U_AREA_KEYS = ["UDå„²ä½å€"];
const U_CODE_KEYS = ["UDå„²ä½å€ä»£ç¢¼"];
const F_AREA_KEYS = ["é¦–æ—¥å„²ä½å€"];
const F_CODE_KEYS = ["é¦–æ—¥å„²ä½å€ä»£ç¢¼"];

const $q=document.getElementById("q"),$tbody=document.getElementById("tbody"),
$meta=document.getElementById("meta"),$err=document.getElementById("error"),
$reload=document.getElementById("reloadBtn"),$selBody=document.getElementById("selBody"),
$selCount=document.getElementById("selCount"),$clearBtn=document.getElementById("clearBtn"),
$exportBtn=document.getElementById("exportBtn"),
$unitSelector=document.querySelector(".unit-selector");

// [Gemini] allRows å„²å­˜å¾ Excel è®€å–çš„å®Œæ•´è³‡æ–™
let allRows=[],fuse=null;
// [Gemini] selected æ”¹ç‚º Mapï¼Œå„²å­˜ { id -> { row: r, unit: 'general' } }
// é€™æ¨£æ‰èƒ½è¨˜ä½æ˜¯å¾å“ªå€‹å–®ä½é¸çš„
const selected=new Map(),qtyMap=new Map();
// [Gemini] å„²å­˜ç›®å‰é¸æ“‡çš„å–®ä½
let currentUnit = 'general';

function pickKey(o,c){for(const k of c)if(k in o)return k;return null;}
// [Gemini] rowId ç¾åœ¨åªä½¿ç”¨è—¥å
function rowId(r){return r.name;}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

// [Gemini] æ–°å¢è¼”åŠ©å‡½æ•¸ï¼Œæ ¹æ“šå–®ä½å–å¾—å°æ‡‰çš„å„²ä½è³‡æ–™
function getUnitData(r, unit) {
  if (!r) return { area: '', code: '' };
  if (unit === 'ud') return { area: r.u_area, code: r.u_code };
  if (unit === 'firstdose') return { area: r.f_area, code: r.f_code };
  return { area: r.g_area, code: r.g_code }; // é è¨­ç‚º 'general'
}
// [Gemini] æ–°å¢è¼”åŠ©å‡½æ•¸ï¼Œå–å¾—å–®ä½åç¨±
function getUnitName(unit) {
  if (unit === 'ud') return 'UD';
  if (unit === 'firstdose') return 'é¦–æ—¥';
  return 'ä¸€èˆ¬';
}

async function loadExcel(){
  $err.textContent="";$reload.disabled=true;$reload.textContent="è¼‰å…¥ä¸­â€¦";
  try{
    const r=await fetch(RAW_URL+"?t="+Date.now());
    if(!r.ok)throw new Error("è®€å–å¤±æ•— "+r.status);
    const buf=await r.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    const js=XLSX.utils.sheet_to_json(sh,{defval:""});
    if(!js.length)throw new Error("Excel ç‚ºç©º");
    
    // [Gemini] è®€å–æ‰€æœ‰å–®ä½çš„æ¬„ä½
    const kN=pickKey(js[0],NAME_KEYS);
    const kGA=pickKey(js[0],G_AREA_KEYS), kGC=pickKey(js[0],G_CODE_KEYS);
    const kUA=pickKey(js[0],U_AREA_KEYS), kUC=pickKey(js[0],U_CODE_KEYS);
    const kFA=pickKey(js[0],F_AREA_KEYS), kFC=pickKey(js[0],F_CODE_KEYS);
    
    // æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦å­˜åœ¨
    if (!kN || (!kGC && !kUC && !kFC)) {
      throw new Error("Excel æ¬„ä½ä¸ç¬¦ï¼Œç¼ºå°‘ 'è—¥å' æˆ–æ‰€æœ‰ 'ä»£ç¢¼' æ¬„ä½ã€‚");
    }

    // [Gemini] å»ºç«‹ allRowsï¼ŒåŒ…å«æ‰€æœ‰å–®ä½çš„è³‡æ–™
    allRows=js.map(r=>({
      name: String(r[kN]??"").trim(),
      g_area: String(r[kGA]??"").trim(),
      g_code: String(r[kGC]??"").trim(),
      u_area: String(r[kUA]??"").trim(),
      u_code: String(r[kUC]??"").trim(),
      f_area: String(r[kFA]??"").trim(),
      f_code: String(r[kFC]??"").trim()
    })).filter(r=>r.name);
    
    // [Gemini] Fuse ç´¢å¼•å»ºç«‹åœ¨ allRows ä¸Š
    fuse=new Fuse(allRows,{includeScore:true,threshold:0.3,keys:["name"]});
    
    $meta.textContent=`å…± ${allRows.length} ç­† Â· è¼‰å…¥æ™‚é–“ï¼š${new Date().toLocaleString()}`;
    render([]);renderSel();
  }catch(e){$err.textContent="éŒ¯èª¤ï¼š"+e.message;$tbody.innerHTML='<tr><td colspan="4" class="empty">ç„¡æ³•è¼‰å…¥è³‡æ–™</td></tr>';}
  $reload.disabled=false;$reload.textContent="é‡æ–°æ•´ç†";
}

function render(list){
  if(!list.length){$tbody.innerHTML='<tr><td colspan="4" class="empty">è«‹è¼¸å…¥é—œéµå­—æŸ¥è©¢</td></tr>';return;}
  
  // [Gemini] æ ¹æ“š currentUnit é¡¯ç¤ºä¸åŒçš„å„²ä½
  $tbody.innerHTML=list.map(r=>{
    const id=rowId(r);
    const chk=selected.has(id)?"checked":"";
    // [Gemini] å–å¾—ç›®å‰é¸æ“‡å–®ä½çš„è³‡æ–™
    const { area, code } = getUnitData(r, currentUnit);
    
    return `<tr data-id="${escapeHTML(id)}">
      <td class="chk-cell"><input type="checkbox" class="chk" ${chk}></td>
      <td>${escapeHTML(r.name)}</td>
      <td>${escapeHTML(area)}</td>
      <td>${escapeHTML(code)}</td>
    </tr>`;
  }).join("");
}

$q.addEventListener("input",()=>{
  const kw=$q.value.trim();
  if(!kw){render([]);return;}
  // [Gemini] æœå°‹æ”¹ç‚º allRows
  const out=allRows.filter(r=>r.name.toLowerCase().includes(kw.toLowerCase()));
  render(out.length?out:(fuse?fuse.search(kw).map(x=>x.item):[]));
});

// [Gemini] ç›£è½å–®ä½é¸å–®è®ŠåŒ–
$unitSelector.addEventListener("change", e => {
  if (e.target.name === 'unit') {
    currentUnit = e.target.value;
    // é‡æ–°è§¸ç™¼æœå°‹ï¼Œä»¥æ›´æ–°é¡¯ç¤ºçš„å„²ä½
    const kw = $q.value.trim();
    if (kw) {
      // è§¸ç™¼ input äº‹ä»¶ä¾†é‡æ–°æœå°‹å’Œæ¸²æŸ“
      $q.dispatchEvent(new Event('input', { bubbles: true }));
    } else {
      render([]); // å¦‚æœæœå°‹æ¡†æ˜¯ç©ºçš„ï¼Œæ¸…ç©ºçµæœ
    }
  }
});

$tbody.addEventListener("change",e=>{
  const el=e.target;if(!el.classList.contains("chk"))return;
  const tr=el.closest("tr");const id=tr.getAttribute("data-id");
  
  // [Gemini] æ›´æ–° selected Map
  if(el.checked){
    // æ‰¾åˆ°å®Œæ•´çš„ row ç‰©ä»¶ä¸¦å­˜å…¥ Map
    const rowData = allRows.find(r => rowId(r) === id);
    if (rowData) {
      selected.set(id, { row: rowData, unit: currentUnit });
    }
  }else{
    selected.delete(id);
    qtyMap.delete(id);
  }
  renderSel();
  // [Gemini] æ›´æ–°æœå°‹åˆ—è¡¨ä¸­çš„å‹¾é¸ç‹€æ…‹ (é¿å…åˆ‡æ›å–®ä½å¾Œå‹¾é¸ç‹€æ…‹ä¸ç¬¦)
  // é€™ä¸€æ­¥é©Ÿæ˜¯å¿…è¦çš„ï¼Œå› ç‚º render() æœƒæ ¹æ“š selected.has(id) ä¾†æ±ºå®šæ˜¯å¦ checked
  // è€Œæˆ‘å€‘å‰›å‰›ä¿®æ”¹äº† selected
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

function renderSel(){
  // [Gemini] æª¢æŸ¥ selected.size
  if(!selected.size){$selBody.innerHTML='<tr><td colspan="6" class="empty">å°šç„¡å‹¾é¸é …ç›®</td></tr>';return;}
  
  let html = [];
  // [Gemini] éæ­· Map
  for (const [id, selData] of selected.entries()) {
    const { row, unit } = selData;
    const { area, code } = getUnitData(row, unit);
    const unitName = getUnitName(unit);
    const qty=qtyMap.get(id)??"";
    
    html.push(`<tr data-id="${escapeHTML(id)}">
      <td>${escapeHTML(row.name)}</td>
      <td><span class="pill">${escapeHTML(unitName)}</span></td>
      <td>${escapeHTML(area)}</td>
      <td>${escapeHTML(code)}</td>
      <td><input class="qty-input" type="number" min="0" max="999" value="${escapeHTML(String(qty))}" data-qty="${escapeHTML(id)}"></td>
      <td><button class="remove-btn" data-remove="${escapeHTML(id)}">âŒ</button></td>
    </tr>`);
  }
  $selBody.innerHTML = html.join("");
  $selCount.textContent=selected.size;
}

$selBody.addEventListener("input",e=>{
  const el=e.target.closest("input[data-qty]");if(!el)return;
  // [Gemini] id (è—¥å) æ˜¯æ­£ç¢ºçš„ key
  const id=el.getAttribute("data-qty"),v=el.value.trim();
  if(v==="")qtyMap.delete(id);else qtyMap.set(id,Math.min(Number(v)||0,999));
});

$selBody.addEventListener("click",e=>{
  const btn=e.target.closest("button[data-remove]");if(!btn)return;
  // [Gemini] id (è—¥å) æ˜¯æ­£ç¢ºçš„ key
  const id=btn.getAttribute("data-remove");
  selected.delete(id);
  qtyMap.delete(id);
  renderSel();
  // [Gemini] åŒæ­¥æ›´æ–°æœå°‹åˆ—è¡¨çš„å‹¾é¸ç‹€æ…‹
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

$clearBtn.addEventListener("click",()=>{
  selected.clear();
  qtyMap.clear();
  renderSel();
  // [Gemini] åŒæ­¥æ›´æ–°æœå°‹åˆ—è¡¨çš„å‹¾é¸ç‹€æ…‹
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

$exportBtn.addEventListener("click",()=>{
  if(!selected.size)return;
  
  // [Gemini] æ›´æ–° CSV æ¨™é ­
  const csvHeader = ["è—¥å“åç¨±,å–®ä½,å„²ä½å€,å„²ä½ä»£ç¢¼,è£œå……æ•¸é‡"];
  const csvRows = [];
  
  // [Gemini] å¾ selected Map ç”¢ç”Ÿ CSV å…§å®¹
  for (const [id, selData] of selected.entries()) {
    const { row, unit } = selData;
    const { area, code } = getUnitData(row, unit);
    const unitName = getUnitName(unit);
    const qty = qtyMap.get(id) ?? "";
    const csvRow = [row.name, unitName, area, code, qty]
      .map(x=>`"${String(x).replace(/"/g,'""')}"`)
      .join(",");
    csvRows.push(csvRow);
  }

  const csv= [csvHeader, ...csvRows].join("\r\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="ä½é™¢è—¥å±€é¸å–æ¸…å–®.csv";a.click();
});

$reload.addEventListener("click",loadExcel);
loadExcel();
})();
</script>

<!-- ğŸ”— åº•éƒ¨è³‡è¨Š -->
<footer style="text-align:center;margin:24px 0;color:#94a3b8;font-size:13px">
  æœ¬å·¥å…·åŸå§‹ç¢¼èˆ‡æ›´æ–°ç‰ˆå¯æ–¼ 
  <a href="https://github.com/Almightyhao/Storage-Code-Finding" 
     target="_blank" 
     style="color:#60a5fa;text-decoration:none">
     GitHubï¼šAlmightyhao/Storage-Code-Finding
  </a> æŸ¥æ‰¾ã€‚
</footer>

</body>
</html>
