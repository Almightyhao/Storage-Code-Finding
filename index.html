<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>儲位查詢 | Storage Code Finder</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial;}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:220px;border:1px solid #1f2937;
      background:#0b1220;color:var(--text);border-radius:12px;
      padding:12px 14px;font-size:16px;outline:none}
    input::placeholder{color:#64748b}
    button{background:var(--accent);border:0;color:#0b1220;
      padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .meta{font-size:12px;color:var(--muted);margin-top:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px}
    th,td{padding:12px 10px;border-bottom:1px solid #1f2937;
      text-align:left;vertical-align:middle}
    th{font-weight:700;color:#cbd5e1}
    tr:hover{background:#0b1220}
    .badge{display:inline-block;background:#0b1220;border:1px solid #1f2937;
      color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
    .empty{color:var(--muted);padding:24px 8px}
    .err{color:#fecaca}
    .chk-cell{width:44px;text-align:center}
    .chk{width:18px;height:18px;cursor:pointer}
    .selected-header{display:flex;align-items:center;
      justify-content:space-between;margin-top:24px}
    .selected-count{font-size:14px;color:#cbd5e1}
    .pill{display:inline-block;background:#0b1220;border:1px solid #1f2937;
      color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
    .selected-actions{display:flex;gap:8px}
    .ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
    .mini{padding:8px 10px;font-size:14px}
    .selected-table td,.selected-table th{border-bottom:1px solid #1f2937}
    .remove-btn{background:transparent;border:1px solid #334155;
      color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
    .remove-btn:hover{border-color:#475569}

    /* 補充數量輸入與即時顯示膠囊 */
    .qty-wrap{display:flex;align-items:center;gap:8px;min-width:0}
    .qty-input{
      width:100%;
      border:1px solid #334155;background:#0b1220;color:#e5e7eb;
      border-radius:10px;padding:8px 10px;font-size:16px;font-weight:700;
      text-align:right;outline:none;
    }
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0; }
    .qty-input[type=number]{ -moz-appearance:textfield; }
    .qty-badge{
      display:inline-block;min-width:2.2em;padding:4px 10px;
      border:1px solid #334155;border-radius:999px;background:#0b1220;color:#e5e7eb;
      font-weight:700;text-align:center;line-height:1.2;white-space:nowrap;
    }

    /* === 手機直式優化（≤480px）：補充數量欄加寬＋上下堆疊 === */
    @media (max-width: 480px){
      .selected-table th:nth-child(1), .selected-table td:nth-child(1){width:34% !important;}
      .selected-table th:nth-child(2), .selected-table td:nth-child(2){width:18% !important;}
      .selected-table th:nth-child(3), .selected-table td:nth-child(3){width:20% !important;}
      .selected-table th:nth-child(4), .selected-table td:nth-child(4){width:28% !important;}
      .qty-wrap{flex-direction:column;align-items:stretch;gap:6px}
      .qty-badge{display:block}
      .remove-btn{padding:6px 8px;font-size:12px}
    }
  </style>

  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>儲位查詢</h1>
      <div class="sub">資料來源會自動抓取 GitHub 上 <span class="badge">main</span> 分支的最新 Excel。</div>

      <div class="row">
        <input id="q" type="text" placeholder="輸入藥名（支援模糊搜尋與部分關鍵字，例如：『阿奇』、『感冒顆粒』...）" />
        <button id="reloadBtn" title="重新抓取最新 Excel">重新整理</button>
      </div>
      <div id="meta" class="meta"></div>
      <div id="error" class="meta err"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th class="chk-cell"><input id="toggleAll" class="chk" type="checkbox" /></th>
            <th style="width:44%">藥品名稱</th>
            <th style="width:28%">儲位區</th>
            <th style="width:28%">庫存區</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="empty">尚未載入資料…</td></tr>
        </tbody>
      </table>

      <div class="selected-header">
        <div class="selected-count">已選清單 <span id="selCount" class="pill">0</span></div>
        <div class="selected-actions">
          <button id="exportBtn" class="ghost mini">匯出 CSV</button>
          <button id="clearBtn" class="ghost mini">全部清空</button>
        </div>
      </div>

      <table class="selected-table">
        <thead>
          <tr>
            <th style="width:42%">藥品名稱</th>
            <th style="width:23%">儲位區</th>
            <th style="width:17%">庫存區</th>
            <th style="width:10%">補充數量</th>
            <th style="width:8%">操作</th>
          </tr>
        </thead>
        <tbody id="selBody">
          <tr><td colspan="5" class="empty">尚無勾選項目</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  const RAW_URL = "https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";
  const NAME_KEYS = ["藥品名稱","品名","藥名","Drug","Name","名稱"];
  const AREA_KEYS = ["儲位區","儲位","儲存區","儲區","Storage","Location"];
  const STOCK_KEYS = ["庫存區","庫存","庫存區位","Stock","Inventory"];

  const $q = document.getElementById("q");
  const $tbody = document.getElementById("tbody");
  const $meta = document.getElementById("meta");
  const $err = document.getElementById("error");
  const $reload = document.getElementById("reloadBtn");
  const $toggleAll = document.getElementById("toggleAll");
  const $selBody = document.getElementById("selBody");
  const $selCount = document.getElementById("selCount");
  const $clearBtn = document.getElementById("clearBtn");
  const $exportBtn = document.getElementById("exportBtn");

  let rows = [];
  let fuse = null;
  let currentView = [];
  const selectedIds = new Set();
  const qtyMap = new Map();
  const STORAGE_KEY = "storage-code-finder:selected";
  const STORAGE_QTY_KEY = "storage-code-finder:qty";

  restoreSelected();
  restoreQty();

  function pickKey(obj, cand){
    for (const k of cand) if (k in obj) return k;
    const keys = Object.keys(obj);
    for (const c of cand.map(s=>s.replace(/\s/g,''))){
      const hit = keys.find(k => k.replace(/\s/g,'')===c);
      if (hit) return hit;
    }
    return null;
  }
  function rowId(r){ return [r.name,r.area,r.stock].join("||"); }

  async function loadExcel(){
    setLoading(true); $err.textContent="";
    try{
      const res = await fetch(RAW_URL + "?t=" + Date.now());
      if(!res.ok) throw new Error("讀取 Excel 失敗（HTTP " + res.status + "）");
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf,{type:"array"});
      const first = wb.SheetNames[0];
      const sheet = wb.Sheets[first];
      const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
      if(!json.length) throw new Error("Excel 內容是空的。");

      const kName = pickKey(json[0], NAME_KEYS);
      const kArea = pickKey(json[0], AREA_KEYS);
      const kStock= pickKey(json[0], STOCK_KEYS);
      if(!kName || !kArea || !kStock){
        throw new Error("找不到必要欄位。需要包含「藥品名稱」「儲位區」「庫存區」。");
      }

      rows = json.map(r=>({
        name:String(r[kName]??"").trim(),
        area:String(r[kArea]??"").trim(),
        stock:String(r[kStock]??"").trim()
      })).filter(r=>r.name);

      fuse = new Fuse(rows,{includeScore:true,threshold:0.3,distance:200,keys:["name"]});

      pruneSelected(); pruneQty();
      $meta.textContent = `共 ${rows.length} 筆 · 來源：main · 載入時間：${new Date().toLocaleString()}`;
      render([]); renderSelected(); $q.focus();
    }catch(e){
      $err.textContent = "發生錯誤：" + e.message;
      $tbody.innerHTML = `<tr><td colspan="4" class="empty">無法載入資料</td></tr>`;
    }finally{ setLoading(false); }
  }

  function setLoading(is){ $reload.disabled=is; $reload.textContent=is?"載入中…":"重新整理"; }
  function escapeHTML(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function render(list){
    currentView = list;
    if(!list.length){
      $tbody.innerHTML = `<tr><td colspan="4" class="empty">${rows.length ? "請輸入關鍵字開始查詢" : "尚未載入資料…"}</td></tr>`;
      updateHeaderToggleState(); return;
    }
    const html = list.map(r=>{
      const id=rowId(r); const checked=selectedIds.has(id)?"checked":"";
      return `<tr data-id="${escapeHTML(id)}">
        <td class="chk-cell"><input type="checkbox" class="chk rowChk" ${checked}></td>
        <td>${escapeHTML(r.name)}</td>
        <td>${escapeHTML(r.area)}</td>
        <td>${escapeHTML(r.stock)}</td>
      </tr>`;
    }).join("");
    $tbody.innerHTML=html; updateHeaderToggleState();
  }

  function updateHeaderToggleState(){
    const ids=currentView.map(rowId);
    let n=0; for(const id of ids) if(selectedIds.has(id)) n++;
    $toggleAll.checked=n===ids.length&&n>0; 
    $toggleAll.indeterminate=n>0&&n<ids.length;
  }

  function renderSelected(){
    const selectedRows=rows.filter(r=>selectedIds.has(rowId(r)));
    if(!selectedRows.length){
      $selBody.innerHTML=`<tr><td colspan="5" class="empty">尚無勾選項目</td></tr>`;
    }else{
      selectedRows.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
      const html=selectedRows.map(r=>{
        const id=rowId(r); const qty=qtyMap.get(id)??"";
        return `<tr data-id="${escapeHTML(id)}">
          <td>${escapeHTML(r.name)}</td>
          <td>${escapeHTML(r.area)}</td>
          <td>${escapeHTML(r.stock)}</td>
          <td><div class="qty-wrap">
              <input class="qty-input" type="number" min="0" step="1" inputmode="numeric"
                value="${escapeHTML(String(qty))}" data-qty-id="${escapeHTML(id)}" placeholder="0">
              <span class="qty-badge" data-qty-badge="${escapeHTML(id)}">${qty===""?"—":escapeHTML(String(qty))}</span>
          </div></td>
          <td><button class="remove-btn" data-remove="${escapeHTML(id)}">移除</button></td>
        </tr>`;
      }).join("");
      $selBody.innerHTML=html;
    }
    $selCount.textContent=String(selectedRows.length);
    persistSelected(); persistQty();
  }

  // 搜尋
  let timer=null;
  $q.addEventListener("input",()=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const kw=$q.value.trim();
      if(!kw){ render([]); return; }
      const contains=rows.filter(r=>r.name.toLowerCase().includes(kw.toLowerCase()));
      const out=contains.length?contains:(fuse?fuse.search(kw).map(x=>x.item):[]);
      render(out);
    },120);
  });

  $reload.addEventListener("click",loadExcel);

  $tbody.addEventListener("change",(e)=>{
    const el=e.target;
    if(!el.classList.contains("rowChk"))return;
    const tr=el.closest("tr");const id=tr.getAttribute("data-id");
    if(el.checked)selectedIds.add(id);else{selectedIds.delete(id);qtyMap.delete(id);}
    updateHeaderToggleState();renderSelected();
  });

  $toggleAll.addEventListener("change",()=>{
    const want=$toggleAll.checked;
    for(const r of currentView){const id=rowId(r);
      if(want)selectedIds.add(id);else{selectedIds.delete(id);qtyMap.delete(id);}
    }
    render(currentView);renderSelected();
  });

  $selBody.addEventListener("click",(e)=>{
    const btn=e.target.closest("button[data-remove]");if(!btn)return;
    const id=btn.getAttribute("data-remove");
    selectedIds.delete(id);qtyMap.delete(id);
    const tr=$tbody.querySelector(`tr[data-id="${id.replace(/("|'|\\)/g,"\\$1")}"]`);
    if(tr){const chk=tr.querySelector(".rowChk");if(chk)chk.checked=false;}
    renderSelected();
  });

  $clearBtn.addEventListener("click",()=>{
    selectedIds.clear();qtyMap.clear();
    $tbody.querySelectorAll(".rowChk").forEach(c=>c.checked=false);
    renderSelected();
  });

  $selBody.addEventListener("input",(e)=>{
    const inp=e.target.closest("input[data-qty-id]");if(!inp)return;
    const id=inp.getAttribute("data-qty-id");const valRaw=inp.value.trim();
    if(valRaw===""){qtyMap.delete(id);}else{
      const n=Number(valRaw);
      if(!Number.isNaN(n)&&n>=0)qtyMap.set(id,Math.floor(n));
    }
    persistQty();
    const badge=$selBody.querySelector(`[data-qty-badge="${id.replace(/("|'|\\)/g,"\\$1")}"]`);
    if(badge)badge.textContent=(valRaw===""?"—":String(Math.floor(Math.max(0,Number(valRaw)||0))));
  });

  $exportBtn.addEventListener("click",()=>{
    const selectedRows=rows.filter(r=>selectedIds.has(rowId(r)));
    if(!selectedRows.length)return;
    const header=["藥品名稱","儲位區","庫存區","補充數量"];
   
