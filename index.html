<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>儲位查詢 | Storage Code Finder</title>
<style>
:root {--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial;}
.wrap{max-width:960px;margin:40px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
h1{margin:0 0 8px;font-size:22px}
.sub{color:var(--muted);margin-bottom:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input[type=text]{flex:1;min-width:220px;border:1px solid #1f2937;background:#0b1220;color:var(--text);
  border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
input::placeholder{color:#64748b}
button{background:var(--accent);border:0;color:#0b1220;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
button:disabled{opacity:.6;cursor:not-allowed}
.meta{font-size:12px;color:var(--muted);margin-top:10px}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px;word-break:break-all}
th,td{padding:12px 10px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:middle}
th{font-weight:700;color:#cbd5e1}
tr:hover{background:#0b1220}
.badge{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
.empty{color:var(--muted);padding:24px 8px}
.err{color:#fecaca}
.chk-cell{width:44px;text-align:center}
.chk{width:18px;height:18px;cursor:pointer}
.selected-header{display:flex;align-items:center;justify-content:space-between;margin-top:24px}
.selected-count{font-size:14px;color:#cbd5e1}
.pill{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
.selected-actions{display:flex;gap:8px}
.ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
.mini{padding:8px 10px;font-size:14px}
.selected-table td,.selected-table th{border-bottom:1px solid #1f2937}
.remove-btn{background:transparent;border:1px solid #334155;color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
.remove-btn:hover{border-color:#475569}
.qty-input{
  width:100%;
  border:1px solid #334155;
  background:#0b1220;
  color:#e5e7eb;
  border-radius:10px;
  padding:8px 10px;
  font-size:16px;
  font-weight:700;
  text-align:center;
  outline:none;
  min-width:60px;
}
@media (max-width:480px){
  .qty-input{font-size:18px;padding:10px;text-align:center;width:100%}
}
</style>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
<div class="wrap"><div class="card">
<h1>儲位查詢</h1>
<div class="sub">資料來源會自動抓取 GitHub 上 <span class="badge">main</span> 分支的最新 Excel。</div>
<div class="row">
  <input id="q" type="text" placeholder="輸入藥名（支援模糊搜尋與部分關鍵字）">
  <button id="reloadBtn">重新整理</button>
</div>
<div id="meta" class="meta"></div><div id="error" class="meta err"></div>
<table id="tbl">
<thead><tr><th class="chk-cell"><input id="toggleAll" class="chk" type="checkbox"></th><th>藥品名稱</th><th>儲位區</th><th>庫存區</th></tr></thead>
<tbody id="tbody"><tr><td colspan="4" class="empty">尚未載入資料…</td></tr></tbody></table>

<div class="selected-header">
  <div class="selected-count">已選清單 <span id="selCount" class="pill">0</span></div>
  <div class="selected-actions">
    <button id="exportBtn" class="ghost mini">匯出 CSV</button>
    <button id="clearBtn" class="ghost mini">全部清空</button>
  </div>
</div>
<table class="selected-table">
<thead><tr><th>藥品名稱</th><th>儲位區</th><th>庫存區</th><th>補充數量</th><th>操作</th></tr></thead>
<tbody id="selBody"><tr><td colspan="5" class="empty">尚無勾選項目</td></tr></tbody>
</table>
</div></div>

<script>
(()=> {
const RAW_URL="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";
const NAME_KEYS=["藥品名稱","品名","藥名","Drug","Name","名稱"];
const AREA_KEYS=["儲位區","儲位","儲存區","儲區","Storage","Location"];
const STOCK_KEYS=["庫存區","庫存","庫存區位","Stock","Inventory"];
const $q=document.getElementById("q"),$tbody=document.getElementById("tbody"),$meta=document.getElementById("meta"),
$err=document.getElementById("error"),$reload=document.getElementById("reloadBtn"),$selBody=document.getElementById("selBody"),
$selCount=document.getElementById("selCount"),$clearBtn=document.getElementById("clearBtn"),$exportBtn=document.getElementById("exportBtn");
let rows=[],fuse=null;const selected=new Set(),qtyMap=new Map();
function pickKey(o,c){for(const k of c)if(k in o)return k;return null;}
function rowId(r){return [r.name,r.area,r.stock].join("||");}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
async function loadExcel(){
  $err.textContent="";$reload.disabled=true;$reload.textContent="載入中…";
  try{
    const r=await fetch(RAW_URL+"?t="+Date.now());
    if(!r.ok)throw new Error("讀取失敗 "+r.status);
    const buf=await r.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    const js=XLSX.utils.sheet_to_json(sh,{defval:""});
    if(!js.length)throw new Error("Excel 為空");
    const kN=pickKey(js[0],NAME_KEYS),kA=pickKey(js[0],AREA_KEYS),kS=pickKey(js[0],STOCK_KEYS);
    rows=js.map(r=>({name:String(r[kN]??"").trim(),area:String(r[kA]??"").trim(),stock:String(r[kS]??"").trim()})).filter(r=>r.name);
    fuse=new Fuse(rows,{includeScore:true,threshold:0.3,keys:["name"]});
    $meta.textContent=`共 ${rows.length} 筆 · 載入時間：${new Date().toLocaleString()}`;
    render([]);renderSel();
  }catch(e){$err.textContent="錯誤："+e.message;$tbody.innerHTML='<tr><td colspan="4" class="empty">無法載入資料</td></tr>';}
  $reload.disabled=false;$reload.textContent="重新整理";
}
function render(list){
  if(!list.length){$tbody.innerHTML='<tr><td colspan="4" class="empty">請輸入關鍵字查詢</td></tr>';return;}
  $tbody.innerHTML=list.map(r=>{
    const id=rowId(r),chk=selected.has(id)?"checked":"";
    return `<tr data-id="${escapeHTML(id)}"><td class="chk-cell"><input type="checkbox" class="chk" ${chk}></td>
    <td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.area)}</td><td>${escapeHTML(r.stock)}</td></tr>`;}).join("");
}
$q.addEventListener("input",()=>{const kw=$q.value.trim();if(!kw){render([]);return;}
  const out=rows.filter(r=>r.name.toLowerCase().includes(kw.toLowerCase()));
  render(out.length?out:(fuse?fuse.search(kw).map(x=>x.item):[]));
});
$tbody.addEventListener("change",e=>{
  const el=e.target;if(!el.classList.contains("chk"))return;
  const tr=el.closest("tr");const id=tr.getAttribute("data-id");
  if(el.checked)selected.add(id);else{selected.delete(id);qtyMap.delete(id);}
  renderSel();
});
function renderSel(){
  const sel=rows.filter(r=>selected.has(rowId(r)));
  if(!sel.length){$selBody.innerHTML='<tr><td colspan="5" class="empty">尚無勾選項目</td></tr>';return;}
  $selBody.innerHTML=sel.map(r=>{
    const id=rowId(r),qty=qtyMap.get(id)??"";
    return `<tr data-id="${escapeHTML(id)}"><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.area)}</td><td>${escapeHTML(r.stock)}</td>
    <td><input class="qty-input" type="number" min="0" value="${escapeHTML(String(qty))}" data-qty="${escapeHTML(id)}"></td>
    <td><button class="remove-btn" data-remove="${escapeHTML(id)}">移除</button></td></tr>`;}).join("");
  $selCount.textContent=sel.length;
}
$selBody.addEventListener("input",e=>{
  const el=e.target.closest("input[data-qty]");if(!el)return;
  const id=el.getAttribute("data-qty"),v=el.value.trim();
  if(v==="")qtyMap.delete(id);else qtyMap.set(id,v);
});
$selBody.addEventListener("click",e=>{
  const btn=e.target.closest("button[data-remove]");if(!btn)return;
  const id=btn.getAttribute("data-remove");selected.delete(id);qtyMap.delete(id);renderSel();
});
$clearBtn.addEventListener("click",()=>{selected.clear();qtyMap.clear();renderSel();});
$exportBtn.addEventListener("click",()=>{
  const sel=rows.filter(r=>selected.has(rowId(r)));if(!sel.length)return;
  const csv=["藥品名稱,儲位區,庫存區,補充數量",...sel.map(r=>{
    const id=rowId(r),qty=qtyMap.get(id)??"";return [r.name,r.area,r.stock,qty].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",");})].join("\r\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="選取清單.csv";a.click();
});
$reload.addEventListener("click",loadExcel);
loadExcel();
})();
</script>
</body></html>
