<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>儲位查詢 | Storage Code Finder</title>
  <!-- 輕量造型 -->
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial;}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:220px;border:1px solid #1f2937;background:#0b1220;color:var(--text);
      border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
    input::placeholder{color:#64748b}
    button{background:var(--accent);border:0;color:#0b1220;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .meta{font-size:12px;color:var(--muted);margin-top:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px}
    th,td{padding:12px 10px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:middle}
    th{font-weight:700;color:#cbd5e1}
    tr:hover{background:#0b1220}
    .badge{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
    .empty{color:var(--muted);padding:24px 8px}
    .err{color:#fecaca}
    /* 勾選框置中 */
    .chk-cell{width:44px;text-align:center}
    .chk{width:18px;height:18px;cursor:pointer}
    /* 已選清單樣式 */
    .selected-header{display:flex;align-items:center;justify-content:space-between;margin-top:24px}
    .selected-count{font-size:14px;color:#cbd5e1}
    .pill{display:inline-block;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
    .selected-actions{display:flex;gap:8px}
    .ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
    .mini{padding:8px 10px;font-size:14px}
    .selected-table td,.selected-table th{border-bottom:1px solid #1f2937}
    .remove-btn{background:transparent;border:1px solid #334155;color:#cbd5e1;padding:6px 10px;border-radius:10px;cursor:pointer}
    .remove-btn:hover{border-color:#475569}
    /* === 新增：補充數量欄位輸入框樣式 === */
    .qty-input{
      width:100%;
      max-width:110px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .qty-input[type=number]{ -moz-appearance:textfield; }
  </style>

  <!-- 讀取 Excel：SheetJS -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- 模糊搜尋：Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>儲位查詢</h1>
      <div class="sub">資料來源會自動抓取 GitHub 上 <span class="badge">main</span> 分支的最新 Excel。</div>

      <div class="row">
        <input id="q" type="text" placeholder="輸入藥名（支援模糊搜尋與部分關鍵字，例如：『阿奇』、『感冒顆粒』...）" />
        <button id="reloadBtn" title="重新抓取最新 Excel">重新整理</button>
      </div>
      <div id="meta" class="meta"></div>
      <div id="error" class="meta err"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th class="chk-cell"><input id="toggleAll" class="chk" type="checkbox" title="目前頁面全選/全不選" /></th>
            <th style="width:44%">藥品名稱</th>
            <th style="width:28%">儲位區</th>
            <th style="width:28%">庫存區</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="empty">尚未載入資料…</td></tr>
        </tbody>
      </table>

      <!-- 已選清單（暫存購物車） -->
      <div class="selected-header">
        <div class="selected-count">已選清單 <span id="selCount" class="pill">0</span></div>
        <div class="selected-actions">
          <button id="exportBtn" class="ghost mini" title="匯出 CSV">匯出 CSV</button>
          <button id="clearBtn" class="ghost mini" title="清空已選">全部清空</button>
        </div>
      </div>

      <table class="selected-table">
        <thead>
          <tr>
            <th style="width:42%">藥品名稱</th>
            <th style="width:23%">儲位區</th>
            <th style="width:17%">庫存區</th>
            <!-- === 新增表頭：補充數量 === -->
            <th style="width:10%">補充數量</th>
            <th style="width:8%">操作</th>
          </tr>
        </thead>
        <tbody id="selBody">
          <tr><td colspan="5" class="empty">尚無勾選項目</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  // 你的 GitHub Raw（main 分支）— 每次都抓最新
  const RAW_URL = "https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";

  // Excel 欄位可能的別名（自動對應）
  const NAME_KEYS   = ["藥品名稱","品名","藥名","Drug","Name","名稱"];
  const AREA_KEYS   = ["儲位區","儲位","儲存區","儲區","Storage","Location"];
  const STOCK_KEYS  = ["庫存區","庫存","庫存區位","Stock","Inventory"];

  const $q = document.getElementById("q");
  const $tbody = document.getElementById("tbody");
  const $meta = document.getElementById("meta");
  const $err = document.getElementById("error");
  const $reload = document.getElementById("reloadBtn");
  const $toggleAll = document.getElementById("toggleAll");
  const $selBody = document.getElementById("selBody");
  const $selCount = document.getElementById("selCount");
  const $clearBtn = document.getElementById("clearBtn");
  const $exportBtn = document.getElementById("exportBtn");

  let rows = [];       // 原始清單（標準化鍵名）
  let fuse = null;     // 模糊搜尋索引
  let lastUpdated = "";
  let currentView = []; // 目前表格顯示的資料（過濾/模糊後）
  const selectedIds = new Set(); // 勾選的 rowId

  // === 新增：補充數量暫存（key: rowId, val: number） ===
  const qtyMap = new Map();

  const STORAGE_KEY = "storage-code-finder:selected";
  const STORAGE_QTY_KEY = "storage-code-finder:qty";

  // 嘗試從 localStorage 還原勾選 & 數量
  restoreSelected();
  restoreQty();

  function pickKey(obj, candidates) {
    for (const k of candidates) if (k in obj) return k;
    // 允許寬鬆匹配（去空白）
    const keys = Object.keys(obj);
    for (const cand of candidates.map(c => c.replace(/\s/g,''))) {
      const hit = keys.find(k => k.replace(/\s/g,'') === cand);
      if (hit) return hit;
    }
    return null;
  }

  function rowId(r) {
    // 用 name/area/stock 三者組合做穩定識別
    return [r.name, r.area, r.stock].join("||");
  }

  async function loadExcel() {
    setLoading(true);
    $err.textContent = "";
    try {
      const url = RAW_URL + "?t=" + Date.now(); // 防止快取
      const res = await fetch(url);
      if (!res.ok) throw new Error("讀取 Excel 失敗（HTTP "+res.status+"）");
      const buf = await res.arrayBuffer();

      const wb = XLSX.read(buf, {type:"array"});
      const first = wb.SheetNames[0];
      const sheet = wb.Sheets[first];
      const json = XLSX.utils.sheet_to_json(sheet, {defval:""});

      if (!json.length) throw new Error("Excel 內容是空的。");

      // 以首列推測欄位名稱
      const probe = json[0];
      const kName  = pickKey(probe, NAME_KEYS);
      const kArea  = pickKey(probe, AREA_KEYS);
      const kStock = pickKey(probe, STOCK_KEYS);

      if (!kName || !kArea || !kStock) {
        throw new Error("找不到必要欄位。需要包含「藥品名稱」「儲位區」「庫存區」（或其別名）。");
      }

      // 標準化
      rows = json.map(r => ({
        name:  String(r[kName]  ?? "").trim(),
        area:  String(r[kArea]  ?? "").trim(),
        stock: String(r[kStock] ?? "").trim(),
      })).filter(r => r.name);

      // 建立模糊索引
      fuse = new Fuse(rows, {
        includeScore: true,
        threshold: 0.3,       // 0 精準 ~ 1 寬鬆
        distance: 200,
        keys: ["name"]
      });

      // 將已選項目 & 數量限縮到仍存在的資料（避免殘留舊 id）
      pruneSelected();
      pruneQty();

      lastUpdated = new Date().toLocaleString();
      $meta.textContent = `共 ${rows.length} 筆 · 來源：main · 載入時間：${lastUpdated}`;
      // 初始顯示空列表引導使用者輸入
      render([]);
      renderSelected();
      $q.focus();
    } catch (e) {
      console.error(e);
      $err.textContent = "發生錯誤： " + e.message + "（請確認 Raw 連結存在且可公開讀取）";
      $tbody.innerHTML = `<tr><td colspan="4" class="empty">無法載入資料</td></tr>`;
    } finally {
      setLoading(false);
    }
  }

  function setLoading(is) {
    $reload.disabled = is;
    $reload.textContent = is ? "載入中…" : "重新整理";
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function render(list) {
    currentView = list; // 記住目前頁面上顯示哪些列（供全選用）
    if (!list.length) {
      $tbody.innerHTML = `<tr><td colspan="4" class="empty">${rows.length ? "請輸入關鍵字開始查詢" : "尚未載入資料…"}</td></tr>`;
      $toggleAll.checked = false;
      $toggleAll.indeterminate = false;
      updateHeaderToggleState();
      return;
    }
    const html = list.map(r => {
      const id = rowId(r);
      const checked = selectedIds.has(id) ? "checked" : "";
      return `
        <tr data-id="${escapeHTML(id)}">
          <td class="chk-cell"><input type="checkbox" class="chk rowChk" ${checked} aria-label="選取 ${escapeHTML(r.name)}"></td>
          <td>${escapeHTML(r.name)}</td>
          <td>${escapeHTML(r.area)}</td>
          <td>${escapeHTML(r.stock)}</td>
        </tr>
      `;
    }).join("");
    $tbody.innerHTML = html;
    updateHeaderToggleState();
  }

  // 根據目前頁面勾選狀態，更新表頭的 toggleAll（全選/全不選/半選）
  function updateHeaderToggleState() {
    const viewIds = currentView.map(rowId);
    if (!viewIds.length) { $toggleAll.checked = false; $toggleAll.indeterminate = false; return; }
    let checkedCount = 0;
    for (const id of viewIds) if (selectedIds.has(id)) checkedCount++;
    if (checkedCount === 0) { $toggleAll.checked = false; $toggleAll.indeterminate = false; }
    else if (checkedCount === viewIds.length) { $toggleAll.checked = true; $toggleAll.indeterminate = false; }
    else { $toggleAll.checked = false; $toggleAll.indeterminate = true; }
  }

  // 渲染「已選清單」
  function renderSelected() {
    const selectedRows = rows.filter(r => selectedIds.has(rowId(r)));
    if (!selectedRows.length) {
      $selBody.innerHTML = `<tr><td colspan="5" class="empty">尚無勾選項目</td></tr>`;
    } else {
      // 依名稱排序，較好找
      selectedRows.sort((a,b)=>a.name.localeCompare(b.name, 'zh-Hant'));
      const html = selectedRows.map(r => {
        const id = rowId(r);
        const qty = qtyMap.get(id) ?? ""; // 顯示已存數量
        return `
          <tr data-id="${escapeHTML(id)}">
            <td>${escapeHTML(r.name)}</td>
            <td>${escapeHTML(r.area)}</td>
            <td>${escapeHTML(r.stock)}</td>
            <!-- === 新增：可手動填寫補充數量 === -->
            <td>
              <input class="qty-input" type="number" min="0" step="1" inputmode="numeric"
                value="${escapeHTML(String(qty))}" data-qty-id="${escapeHTML(id)}" placeholder="0" aria-label="補充數量">
            </td>
            <td><button class="remove-btn" data-remove="${escapeHTML(id)}">移除</button></td>
          </tr>
        `;
      }).join("");
      $selBody.innerHTML = html;
    }
    $selCount.textContent = String(selectedRows.length);
    persistSelected();
    persistQty();
  }

  // —— 事件：搜尋（debounce）
  let timer = null;
  $q.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const kw = $q.value.trim();
      if (!kw) { render([]); return; }
      const contains = rows.filter(r => r.name.toLowerCase().includes(kw.toLowerCase()));
      const out = contains.length ? contains : (fuse ? fuse.search(kw).map(x => x.item) : []);
      render(out);
    }, 120);
  });

  // —— 事件：重新整理
  $reload.addEventListener("click", loadExcel);

  // —— 事件：表格內勾選切換（事件委派）
  $tbody.addEventListener("change", (e) => {
    const el = e.target;
    if (!el.classList.contains("rowChk")) return;
    const tr = el.closest("tr");
    if (!tr) return;
    const id = tr.getAttribute("data-id");
    if (!id) return;
    if (el.checked) selectedIds.add(id);
    else {
      selectedIds.delete(id);
      // 勾選取消時，同步清掉該品項的補充數量
      qtyMap.delete(id);
    }
    updateHeaderToggleState();
    renderSelected();
  });

  // —— 事件：表頭全選/全不選
  $toggleAll.addEventListener("change", () => {
    const wantCheck = $toggleAll.checked;
    for (const r of currentView) {
      const id = rowId(r);
      if (wantCheck) selectedIds.add(id);
      else {
        selectedIds.delete(id);
        qtyMap.delete(id); // 同步清掉數量
      }
    }
    // 更新目前畫面與已選清單
    render(currentView);
    renderSelected();
  });

  // —— 事件：已選清單的「移除」按鈕（事件委派）
  $selBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-remove]");
    if (!btn) return;
    const id = btn.getAttribute("data-remove");
    selectedIds.delete(id);
    qtyMap.delete(id); // 同步清掉數量
    // 若此 id 目前也在上方列表，就把它的 checkbox 取消勾選
    const tr = $tbody.querySelector(`tr[data-id="${cssEscape(id)}"]`);
    if (tr) {
      const chk = tr.querySelector(".rowChk");
      if (chk) chk.checked = false;
      updateHeaderToggleState();
    }
    renderSelected();
  });

  // —— 事件：清空
  $clearBtn.addEventListener("click", () => {
    if (!selectedIds.size) return;
    selectedIds.clear();
    qtyMap.clear(); // 全部清空數量
    // 取消目前畫面所有勾選
    const chks = $tbody.querySelectorAll(".rowChk");
    chks.forEach(c => c.checked = false);
    updateHeaderToggleState();
    renderSelected();
  });

  // —— 事件：補充數量輸入（事件委派）
  $selBody.addEventListener("input", (e) => {
    const inp = e.target.closest("input[data-qty-id]");
    if (!inp) return;
    const id = inp.getAttribute("data-qty-id");
    // 僅接受 >=0 的整數（若空字串保留空白，方便之後手動補）
    const valRaw = inp.value.trim();
    if (valRaw === "") {
      qtyMap.delete(id);
    } else {
      const n = Number(valRaw);
      if (!Number.isNaN(n) && n >= 0) {
        qtyMap.set(id, Math.floor(n));
      }
    }
    persistQty();
  });

  // —— 事件：匯出 CSV（含補充數量）
  $exportBtn.addEventListener("click", () => {
    const selectedRows = rows.filter(r => selectedIds.has(rowId(r)));
    if (!selectedRows.length) return;
    const header = ["藥品名稱","儲位區","庫存區","補充數量"]; // === 新增欄位 ===
    const lines = [header, ...selectedRows.map(r => {
      const id = rowId(r);
      const qty = qtyMap.get(id);
      return [r.name, r.area, r.stock, (qty ?? "").toString()];
    })];
    const csv = lines.map(cols => cols.map(toCSVCell).join(",")).join("\r\n");
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `選取清單_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  function toCSVCell(s){
    const needsQuote = /[",\r\n]/.test(s);
    let t = s.replace(/"/g,'""');
    return needsQuote ? `"${t}"` : t;
  }

  // 防止 querySelector 選擇器特殊字元問題
  function cssEscape(str){
    return str.replace(/("|'|\\)/g, "\\$1");
  }

  // 移除不存在於現有 rows 的已選 id
  function pruneSelected(){
    const valid = new Set(rows.map(rowId));
    for (const id of [...selectedIds]) {
      if (!valid.has(id)) selectedIds.delete(id);
    }
    persistSelected();
  }

  // === 新增：移除不存在於現有 rows 的數量紀錄 ===
  function pruneQty(){
    const valid = new Set(rows.map(rowId));
    for (const [id] of [...qtyMap.entries()]) {
      if (!valid.has(id)) qtyMap.delete(id);
    }
    persistQty();
  }

  // localStorage 持久化（勾選）
  function persistSelected(){
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...selectedIds]));
    } catch {}
  }
  function restoreSelected(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) arr.forEach(id => selectedIds.add(String(id)));
    } catch {}
  }

  // === 新增：localStorage 持久化（補充數量） ===
  function persistQty(){
    try {
      const obj = {};
      for (const [k,v] of qtyMap.entries()) obj[k] = v;
      localStorage.setItem(STORAGE_QTY_KEY, JSON.stringify(obj));
    } catch {}
  }
  function restoreQty(){
    try {
      const raw = localStorage.getItem(STORAGE_QTY_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === "object") {
        for (const [k,v] of Object.entries(obj)) {
          if (v === "" || v === null || typeof v === "undefined") continue;
          const n = Number(v);
          if (!Number.isNaN(n) && n >= 0) qtyMap.set(String(k), Math.floor(n));
        }
      }
    } catch {}
  }

  // 進頁即載
  loadExcel();
})();
</script>
</body>
</html>
