<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>藥品儲位快速查找</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
    <header>
      <h1 class="text-2xl font-bold">藥品儲位快速查找</h1>
      <p class="text-sm text-gray-600">
        資料來源：
        <a href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx" target="_blank" class="underline">
          GitHub Raw（main）
        </a>
      </p>
    </header>

    <section class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex gap-2">
        <input id="txtQuery" class="flex-1 border rounded px-3 py-2" placeholder="輸入藥品名稱或關鍵字" />
        <button id="btnClear" class="px-3 py-2 border rounded">清除</button>
      </div>
      <div class="flex gap-2 text-sm">
        <label><input id="chkIgnorePunc" type="checkbox" checked> 忽略空白與符號</label>
        <label><input id="chkAllTokens" type="checkbox" checked> 多關鍵字需全部命中</label>
      </div>
      <div class="text-sm text-gray-600">
        符合 <b id="matchCount">0</b> 筆；顯示前 <span id="lblShow">100</span> 筆
      </div>
    </section>

    <section class="bg-white rounded-xl shadow overflow-hidden">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left border-b">藥品名稱</th>
              <th class="px-3 py-2 text-left border-b">儲位區</th>
              <th class="px-3 py-2 text-left border-b">庫存區</th>
              <th class="px-3 py-2 text-left border-b">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
const RAW_URL = "https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";
const $ = id => document.getElementById(id);
let rows = [];

function strip(s){ return (s??"").toString().replace(/[^0-9A-Za-z\u4e00-\u9fa5]+/g,"").toLowerCase(); }
function contains(h, n, ign){ const H = ign?strip(h):(h??"").toString().toLowerCase(); const N = ign?strip(n):(n??"").toString().toLowerCase(); return H.includes(N); }

function render(){
  const q = $("txtQuery").value.trim();
  const tokens = q? q.split(/\s+/).filter(Boolean): [];
  const ign = $("chkIgnorePunc").checked;
  const all = $("chkAllTokens").checked;
  const filtered = rows.filter(r=>{
    if(tokens.length===0) return true;
    const fields = [r["藥品名稱"], r["儲位區"], r["庫存區"]];
    function has(tok){ return fields.some(f=>contains(f,tok,ign)); }
    return all ? tokens.every(has) : tokens.some(has);
  });
  $("matchCount").textContent = filtered.length;
  $("lblShow").textContent = 100;
  const data = filtered.slice(0,100);
  const tbody = $("tbody"); tbody.innerHTML="";
  if(data.length===0){ tbody.innerHTML = `<tr><td colspan=4 class="text-center text-gray-500 py-6">找不到符合「${q}」的資料</td></tr>`; return; }
  for(const r of data){
    const tr = document.createElement("tr"); tr.className="odd:bg-white even:bg-gray-50";
    tr.innerHTML = `
      <td class="px-3 py-2 border-b">${r["藥品名稱"]||""}</td>
      <td class="px-3 py-2 border-b">${r["儲位區"]||""}</td>
      <td class="px-3 py-2 border-b">${r["庫存區"]||""}</td>
      <td class="px-3 py-2 border-b"><button class="px-2 py-1 border rounded text-xs" onclick="navigator.clipboard.writeText('${r["儲位區"]||""}')">複製儲位</button></td>`;
    tbody.appendChild(tr);
  }
}

async function load(){
  try{
    const resp = await fetch(RAW_URL + "?_ts=" + Date.now());
    const buf = await resp.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
    render();
  }catch(e){
    $("tbody").innerHTML = `<tr><td colspan=4 class="text-center text-red-600 py-6">載入失敗：${e.message}</td></tr>`;
  }
}

$("txtQuery").addEventListener("input", render);
$("btnClear").addEventListener("click", ()=>{ $("txtQuery").value=""; render(); });
$("chkIgnorePunc").addEventListener("change", render);
$("chkAllTokens").addEventListener("change", render);

load();
</script>
</body>
</html>
