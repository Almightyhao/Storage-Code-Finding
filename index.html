<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>住院藥局儲位查詢 | Inpatient Pharmacy Finder</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">
<link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">
<link rel="shortcut icon" href="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/IPD.jpg">

<style>
:root {--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--border:#1f2937;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Helvetica Neue",Arial;}
.wrap{max-width:960px;margin:40px auto;padding:0 16px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
h1{margin:0 0 8px;font-size:22px}
.sub{color:var(--muted);margin-bottom:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input[type=text]{flex:1;min-width:220px;border:1px solid var(--border);background:#0b1220;color:var(--text);
  border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
input::placeholder{color:#64748b}
button{background:var(--accent);border:0;color:#0b1220;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
button:disabled{opacity:.6;cursor:not-allowed}
.meta{font-size:12px;color:var(--muted);margin-top:10px}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px;word-break:break-all}
th,td{padding:12px 8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
th{font-weight:700;color:#cbd5e1}
tr:hover{background:#0b1220}
.badge{display:inline-block;background:#0b1220;border:1px solid var(--border);color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
.empty{color:var(--muted);padding:24px 8px;text-align:center}
.err{color:#fecaca}
.chk-cell{width:40px;text-align:center}
.chk{width:18px;height:18px;cursor:pointer}
.selected-header{display:flex;align:items-center;justify-content:space-between;margin-top:24px}
.selected-count{font-size:14px;color:#cbd5e1}
.pill{display:inline-block;background:#0b1220;border:1px solid var(--border);color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
.selected-actions{display:flex;gap:8px}
.ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
.mini{padding:8px 10px;font-size:14px}
.selected-table td,.selected-table th{border-bottom:1px solid var(--border)}

.qty-input{
  width:60px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e5e7eb;
  border-radius:8px;
  padding:6px;
  font-size:15px;
  font-weight:600;
  text-align:center;
  outline:none;
}
.qty-input::-webkit-inner-spin-button,
.qty-input::-webkit-outer-spin-button{
  -webkit-appearance:none;margin:0;
}

.remove-btn{
  background:transparent;
  border:1px solid #334155;
  color:#cbd5e1;
  padding:4px 8px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  line-height:1;
}
.remove-btn:hover{background:#1f2937;border-color:#475569;color:#fca5a5}

/* 分組選單樣式 */
.group-container {
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 16px;
}
.group-label {
  font-size: 13px;
  color: var(--accent);
  margin-bottom: 8px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.unit-selector {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.unit-selector:last-child {
  margin-bottom: 0;
}
.radio-label {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text);
  cursor: pointer;
  font-size: 14px;
  background: #1e293b;
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: all 0.2s;
}
.radio-label:hover {
  background: #334155;
}
.radio-label input {
  width: 14px;
  height: 14px;
  accent-color: var(--accent);
}
/* 當選中時的樣式 */
.radio-label:has(input:checked) {
  background: rgba(96, 165, 250, 0.2);
  border-color: var(--accent);
  color: white;
}

@media (max-width:600px){
  th,td{font-size:14px;padding:10px 6px;}
  .qty-input{width:55px;font-size:15px;}
  .remove-btn{padding:4px 6px;font-size:15px;}
  .unit-selector {gap: 8px;}
  .radio-label {padding: 6px 10px; font-size: 13px;}
}
</style>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
<div class="wrap"><div class="card">
<h1>住院藥局儲位查詢</h1>
<div class="sub">資料來源：GitHub <span class="badge">main</span> 分支 Storage Code.xlsx</div>

<div class="group-container" id="radioGroupContainer">
  <div class="group-label">線上架儲區 (代碼)</div>
  <div class="unit-selector">
    <label class="radio-label"><input type="radio" name="unit" value="general_shelf"> 一般儲位區</label>
    <label class="radio-label"><input type="radio" name="unit" value="ud_shelf" checked> UD儲位區</label>
    <label class="radio-label"><input type="radio" name="unit" value="first_shelf"> 首日儲位區</label>
  </div>
  
  <div class="group-label" style="margin-top:12px;">儲位區 (區域/代碼)</div>
  <div class="unit-selector">
    <label class="radio-label"><input type="radio" name="unit" value="discharge_code"> 出院儲位</label>
    <label class="radio-label"><input type="radio" name="unit" value="ud_area"> UD儲位區</label>
    <label class="radio-label"><input type="radio" name="unit" value="first_area"> 首日儲位區</label>
    <label class="radio-label"><input type="radio" name="unit" value="inventory"> 庫存區</label>
  </div>
</div>

<div class="row">
  <input id="q" type="text" placeholder="輸入藥名搜尋...">
  <button id="reloadBtn">重新整理</button>
</div>
<div id="meta" class="meta"></div><div id="error" class="meta err"></div>

<table id="tbl">
<thead><tr>
  <th class="chk-cell"><input id="toggleAll" class="chk" type="checkbox"></th>
  <th>藥品名稱</th>
  <th>儲位/代碼</th>
</tr></thead>
<tbody id="tbody"><tr><td colspan="3" class="empty">尚未載入資料…</td></tr></tbody>
</table>

<div class="selected-header">
  <div class="selected-count">已選清單 <span id="selCount" class="pill">0</span></div>
  <div class="selected-actions">
    <button id="exportBtn" class="ghost mini">匯出 CSV</button>
    <button id="clearBtn" class="ghost mini">全部清空</button>
  </div>
</div>

<table class="selected-table">
<thead><tr>
  <th>藥品名稱</th>
  <th>類型</th>
  <th>儲位/代碼</th>
  <th>補充數量</th>
  <th>操作</th>
</tr></thead>
<tbody id="selBody"><tr><td colspan="5" class="empty">尚無勾選項目</td></tr></tbody>
</table>
</div></div>

<script>
(()=> {
// GitHub 檔案路徑
const RAW_URL="https://raw.githubusercontent.com/Almightyhao/Storage-Code-Finding/main/Storage%20Code.xlsx";

// 關鍵字定義 (Excel Header Mapping)
const NAME_KEYS = ["藥名","品名","Drug","Name","名稱","藥品名稱"];

// 線上架儲區 (代碼)
const K_GEN_SHELF = ["一般儲位區代碼", "一般儲位區"];
const K_UD_SHELF = ["UD儲位區代碼"];
const K_FIRST_SHELF = ["首日儲位區代碼"];

// 儲位區 (區域/代碼)
const K_DISCHARGE = ["出院儲位代碼", "出院儲位區代碼"];
const K_UD_AREA = ["UD儲位區"];
const K_FIRST_AREA = ["首日儲位區"];
const K_INV = ["庫存區", "庫存區代碼"];

const $q=document.getElementById("q"),$tbody=document.getElementById("tbody"),
$meta=document.getElementById("meta"),$err=document.getElementById("error"),
$reload=document.getElementById("reloadBtn"),$selBody=document.getElementById("selBody"),
$selCount=document.getElementById("selCount"),$clearBtn=document.getElementById("clearBtn"),
$exportBtn=document.getElementById("exportBtn"),
$radioContainer=document.getElementById("radioGroupContainer");

let allRows=[],fuse=null;
const selected=new Map(),qtyMap=new Map();
// 預設選項
let currentUnit = 'ud_shelf';

function pickKey(o,c){for(const k of c)if(k in o)return k;return null;}
function rowId(r){return r.name;}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

// 根據 currentUnit 回傳對應的欄位資料
function getUnitData(r, unit) {
  if (!r) return { code: '' };
  switch(unit) {
    case 'general_shelf': return { code: r.gen_shelf };
    case 'ud_shelf': return { code: r.ud_shelf };
    case 'first_shelf': return { code: r.first_shelf };
    case 'discharge_code': return { code: r.discharge };
    case 'ud_area': return { code: r.ud_area };
    case 'first_area': return { code: r.first_area };
    case 'inventory': return { code: r.inv };
    default: return { code: '' };
  }
}

// 取得顯示名稱 (用於表格與 CSV)
function getUnitName(unit) {
  const map = {
    'general_shelf': '一般架儲',
    'ud_shelf': 'UD架儲',
    'first_shelf': '首日架儲',
    'discharge_code': '出院儲位',
    'ud_area': 'UD儲位區',
    'first_area': '首日儲位區',
    'inventory': '庫存區'
  };
  return map[unit] || '未知';
}

async function loadExcel(){
  $err.textContent="";$reload.disabled=true;$reload.textContent="載入中…";
  try{
    const r=await fetch(RAW_URL+"?t="+Date.now());
    if(!r.ok)throw new Error("讀取失敗 "+r.status);
    const buf=await r.arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    const js=XLSX.utils.sheet_to_json(sh,{defval:""});
    if(!js.length)throw new Error("Excel 為空");
    
    // 偵測 Excel 欄位 Key
    const h = js[0]; // 第一筆資料通常包含 key，若為空字串可能被忽略，但 json key 仍存在
    const kN = pickKey(h, NAME_KEYS);
    
    // 線上架儲
    const kGS = pickKey(h, K_GEN_SHELF);
    const kUS = pickKey(h, K_UD_SHELF);
    const kFS = pickKey(h, K_FIRST_SHELF);
    
    // 儲位區
    const kDC = pickKey(h, K_DISCHARGE);
    const kUA = pickKey(h, K_UD_AREA);
    const kFA = pickKey(h, K_FIRST_AREA);
    const kIV = pickKey(h, K_INV);
    
    if (!kN) throw new Error("Excel 缺少「藥品名稱」欄位");
    
    // 建立資料物件
    allRows = js.map(r => ({
      name: String(r[kN]??"").trim(),
      gen_shelf: kGS ? String(r[kGS]??"").trim() : "",
      ud_shelf: kUS ? String(r[kUS]??"").trim() : "",
      first_shelf: kFS ? String(r[kFS]??"").trim() : "",
      discharge: kDC ? String(r[kDC]??"").trim() : "",
      ud_area: kUA ? String(r[kUA]??"").trim() : "",
      first_area: kFA ? String(r[kFA]??"").trim() : "",
      inv: kIV ? String(r[kIV]??"").trim() : ""
    }))
    .filter(r => r.name && r.name !== "藥品名稱" && r.name !== "Name"); // 排除空行與重複標題

    fuse=new Fuse(allRows,{includeScore:true,threshold:0.3,keys:["name"]});
    
    $meta.textContent=`共 ${allRows.length} 筆 · 載入時間：${new Date().toLocaleString()}`;
    render([]);renderSel();
  }catch(e){$err.textContent="錯誤："+e.message;$tbody.innerHTML='<tr><td colspan="3" class="empty">無法載入資料</td></tr>';}
  $reload.disabled=false;$reload.textContent="重新整理";
}

function render(list){
  if(!list.length){$tbody.innerHTML='<tr><td colspan="3" class="empty">請輸入關鍵字查詢</td></tr>';return;}
  
  $tbody.innerHTML=list.map(r=>{
    const id=rowId(r);
    const chk=selected.has(id)?"checked":"";
    const { code } = getUnitData(r, currentUnit);
    
    return `<tr data-id="${escapeHTML(id)}">
      <td class="chk-cell"><input type="checkbox" class="chk" ${chk}></td>
      <td>${escapeHTML(r.name)}</td>
      <td>${escapeHTML(code)}</td>
    </tr>`;
  }).join("");
}

$q.addEventListener("input",()=>{
  const kw=$q.value.trim();
  if(!kw){render([]);return;}
  const out=allRows.filter(r=>r.name.toLowerCase().includes(kw.toLowerCase()));
  render(out.length?out:(fuse?fuse.search(kw).map(x=>x.item):[]));
});

// 監聽所有 radio button 的變化
$radioContainer.addEventListener("change", e => {
  if (e.target.name === 'unit') {
    currentUnit = e.target.value;
    const kw = $q.value.trim();
    if (kw) {
      $q.dispatchEvent(new Event('input', { bubbles: true }));
    } else {
      render([]);
    }
  }
});

$tbody.addEventListener("change",e=>{
  const el=e.target;if(!el.classList.contains("chk"))return;
  const tr=el.closest("tr");const id=tr.getAttribute("data-id");
  
  if(el.checked){
    const rowData = allRows.find(r => rowId(r) === id);
    if (rowData) {
      selected.set(id, { row: rowData, unit: currentUnit });
    }
  }else{
    selected.delete(id);
    qtyMap.delete(id);
  }
  renderSel();
  // 同步更新搜尋列表勾選狀態
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

function renderSel(){
  if(!selected.size){$selBody.innerHTML='<tr><td colspan="5" class="empty">尚無勾選項目</td></tr>';return;}
  
  let html = [];
  for (const [id, selData] of selected.entries()) {
    const { row, unit } = selData;
    const { code } = getUnitData(row, unit);
    const unitName = getUnitName(unit);
    const qty=qtyMap.get(id)??"";
    
    html.push(`<tr data-id="${escapeHTML(id)}">
      <td>${escapeHTML(row.name)}</td>
      <td><span class="pill">${escapeHTML(unitName)}</span></td>
      <td>${escapeHTML(code)}</td>
      <td><input class="qty-input" type="number" min="0" max="999" value="${escapeHTML(String(qty))}" data-qty="${escapeHTML(id)}"></td>
      <td><button class="remove-btn" data-remove="${escapeHTML(id)}">❌</button></td>
    </tr>`);
  }
  $selBody.innerHTML = html.join("");
  $selCount.textContent=selected.size;
}

$selBody.addEventListener("input",e=>{
  const el=e.target.closest("input[data-qty]");if(!el)return;
  const id=el.getAttribute("data-qty"),v=el.value.trim();
  if(v==="")qtyMap.delete(id);else qtyMap.set(id,Math.min(Number(v)||0,999));
});

$selBody.addEventListener("click",e=>{
  const btn=e.target.closest("button[data-remove]");if(!btn)return;
  const id=btn.getAttribute("data-remove");
  selected.delete(id);
  qtyMap.delete(id);
  renderSel();
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

$clearBtn.addEventListener("click",()=>{
  selected.clear();
  qtyMap.clear();
  renderSel();
  const kw = $q.value.trim();
  if (kw) { $q.dispatchEvent(new Event('input', { bubbles: true })); }
});

$exportBtn.addEventListener("click",()=>{
  if(!selected.size)return;
  
  const csvHeader = ["藥品名稱,類型,儲位/代碼,補充數量"];
  const csvRows = [];
  
  for (const [id, selData] of selected.entries()) {
    const { row, unit } = selData;
    const { code } = getUnitData(row, unit);
    const unitName = getUnitName(unit);
    const qty = qtyMap.get(id) ?? "";
    const csvRow = [row.name, unitName, code, qty]
      .map(x=>`"${String(x).replace(/"/g,'""')}"`)
      .join(",");
    csvRows.push(csvRow);
  }

  const csv= [csvHeader, ...csvRows].join("\r\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="住院藥局選取清單.csv";a.click();
});

$reload.addEventListener("click",loadExcel);
loadExcel();
})();
</script>

<footer style="text-align:center;margin:24px 0;color:#94a3b8;font-size:13px">
  本工具原始碼與更新版可於 
  <a href="https://github.com/Almightyhao/Storage-Code-Finding" 
     target="_blank" 
     style="color:#60a5fa;text-decoration:none">
     GitHub：Almightyhao/Storage-Code-Finding
  </a> 查找。
</footer>
</body>
</html>
